---
title: "Exploratory Data Analysis"
author: "Marc Galland"
date: "`r Sys.Date()`"
output:
    html_document:
        keep_md: true
---
# Introduction
In this document, we are going to see how to get a grasp of a new dataset. Whenever you collect experimental data, you will have to explore your data using some descriptive statistics. By using two powerful R packages (``tidyverse`` and ``ggplot2``). We will make hypothesis and turn them into code and plots.
Some additional packages will also be used (and loaded when needed).

## Load libraries 
```{r setup,message=FALSE,warning=FALSE}
# install or simply load libraries
if (require("tidyverse") == FALSE)  {
  # no package, it installs it
  print("tidyverse package not found, installing from https://cloud.r-project.org/")
  install.packages("tidyverse",repos = "https://cloud.r-project.org/")  
} else {
  library("tidyverse")
}

if (require("nycflights13") == FALSE)  {
  # no package, it installs it
  print("nycflights13 package not found, installing from https://cloud.r-project.org/")
  install.packages("nycflights13",repos = "https://cloud.r-project.org/")  
} else {
  library("nycflights13")
}
```

## Explore the "nycflights13" dataset
We’d all like to arrive at our destinations on time whenever possible. We’re going to analyze data related to flights contained in the ``nycflights13`` package (Wickham 2017). Specifically, this package contains five datasets saved as “data frames” with information about all domestic flights departing from New York City in 2013, from either Newark Liberty International (EWR), John F. Kennedy International (JFK), or LaGuardia (LGA) airports.

Let's have a look at this dataset. 
```{r glimpse}
# the head command
head(flights)

# The view command
View(flights)

# The glimpse command
glimpse(flights)
```

While the ``head`` command helps you to have a look at the first lines, the ``glimpse`` command allows you to see all variables (19 columns) at once. Since the dataframe is a **tible** (see glossary) you also see how R encode the different columns (int for integer, chr for character, etc.)

**Explanations of the variables (columns):**
* year,month,day: Date of departure
* dep_time,arr_time: Actual departure and arrival times, local tz.
* sched_dep_time,sched_arr_time: Scheduled departure and arrival times, local tz.
* dep_delay,arr_delay: Departure and arrival delays, in minutes. Negative times represent early departures/arrivals.
* hour,minute: Time of scheduled departure broken into hour and minutes.
* carrier: Two letter carrier abbreviation. See airlines to get name
* tailnum: Plane tail number
* flight: Flight number
* origin,dest: Origin and destination. See airports for additional metadata.
* air_time: Amount of time spent in the air, in minutes
* distance: Distance between airports, in miles
* time_hour: Scheduled date and hour of the flight as a POSIXct date. Along with origin, can be used to join flights data to weather data.

This ``flights`` dataset is a good example of a tidy dataset. There is one unique value per line and variables are well separated. For instance, ``year``, ``month`` and ``day`` are separated. 

# Data exploration - Univariate (one variable at a time)
Exploring data is about making hypothesis and translating them into code.This dataset list flight delays and list multiple variables that can potentially explain delays.    
First, we will see how the distribution of delays look like. 

Let's first take a subset of this big dataframe. We will focus on the flights leaving the **John Fitzgerald Kennedy airport of New York** and arriving at the **Los Angeles international airport**.  

## Data subsetting using the pipe notation (%>%)
```{r Subset}
# filtering by destination and arrival airports   
# na.omit removes the "NA" missing values
jfk = flights %>% filter(origin == "JFK",dest == "LAX") %>% na.omit()

# let's have a look at the numbers of remaining rows
dim(flights)
dim(jfk)
```
**Question:** How can you show the first lines of the ``jfk`` tibble?  

## Plotting a distribution for arrival delays
```{r delay distribution}
# default 
p30 <- ggplot(data=jfk,aes(x=arr_delay)) + 
  geom_histogram(binwidth = 30) # The width of the bins. By default 30
print(p30)

# with different values 
p100 <- ggplot(data=jfk,aes(x=arr_delay)) + 
  geom_histogram(binwidth = 10) # better for our values
print(p100)
```

## Plotting the number of flights operated per flight company (``carrier``)
Here, we see that we can create a barplot for a variable with the ``geom_bar``. 
```{r nb flights per company}
# barplot
p.carrier = ggplot(data = jfk,aes(x=carrier)) +
  geom_bar(color="white")
print(p.carrier)

# the last plot showed the number of flights per carrier. Data can be obtained with:
jfk %>% group_by(carrier) %>% summarize(number = n()) 
```

## Finding the mean and standard deviation 
1. For all flights
2. Per month
3. Per company
```{r delay mean / sd}
# global mean and standard deviation (sd) for arrival delay
# Rounded to 2 digits
jfk %>% summarize(.,mean = mean(arr_delay),sd=sd(arr_delay))

# Mean and standard deviation per carrier company
# first calculate per carrier 
# then plot with error bars

delayPercompany = 
  jfk %>%
  group_by(carrier) %>%
  summarize(.,
            mean = mean(arr_delay), 
            sd = mean(arr_delay)
  )
# plot with standard deviation bars
p.delayPercompany = ggplot(data = delayPercompany,aes(x = carrier,y = mean,fill=carrier)) +
    geom_bar(stat="identity") +
   geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), colour="black", width=.1) 
print(p.delayPercompany)    
```
**Question**: do you know plots that display some additional informationon the `àrr_delay`` variable distribution  

# Bivariate analysis (two variables at a time)
## Relationship between variables
Now that we have explored univarite, we can try to see relationships between two variables. 

First, is there a relationship between ``dep_delay`` and ``arr_delay``?
```{r arrival - departure delays}
# simple scatterplot departure delay versus 
p.arr_dep1 = ggplot(na.omit(flights),aes(dep_delay,arr_delay)) + 
  geom_point()
print(p.arr_dep1)

# scatterplot with carrier company 
p.arr_dep2 = ggplot(na.omit(flights),aes(dep_delay,arr_delay,colour=carrier)) + 
  geom_point()
print(p.arr_dep2)
```

Then, between ``arr_delay`` and the ``distance`` traveled?
```{r arr vs distance}
# scatterplot with carrier company 
p.arr_dist = ggplot(na.omit(flights),aes(distance,arr_delay,colour=carrier)) + 
  geom_point()
print(p.arr_dist)
```

**Question**: Can you think of other relationships? Tip: to print all variables, type ``glimpse(flights)`` 

## Multivariate analysis
### By "eye": heatmap
Using the R package "superheat", we will make a colored heatmap ((table with colors intensity reflecting values) of some variables of the flights going from JFK airport to Los Angeles for only one company (United Airlines = UA)
```{r heatmap}
# install or simply load libraries
if (require("superheat") == FALSE)  {
  # no package, it installs it
  print("superheat package not found, installing from https://cloud.r-project.org/")
  install.packages("superheat",repos = "https://cloud.r-project.org/")  
} else {
  library("superheat")
}

# create a dataset
ua = flights %>% 
  filter(.,carrier=="UA") %>%
  filter(.,dep_delay > 0 & arr_delay > 0) %>%
  select(.,dep_time,arr_time,dep_delay,arr_delay,distance) %>%
  head(.,n=5000)

ua <- as.data.frame(ua)
row.names(ua) = ua$flight
ua$flight = NULL
ua = log(ua,base = 2)

# make a heatmap 
superheat(ua,
          # normalise variables (so they become comparable)
          scale = T,
           heat.pal = c("#b35806", "white", "#542788"),
          pretty.order.rows = T,
          pretty.order.cols = T
          )
```

### Principal Component Analysis
```{r PCA}
flights.pca <- dplyr::select(flights,carrier,dep_delay,arr_delay,distance,air_time)

# compute PCA
res.pca <- prcomp(flights.pca[,2:5],scale=TRUE)
fviz_eig(res.pca)

```

# Making hypothesis: a first step into regressions
How can we explain delays? We have seen that delauys 

## Hypothesis 1: delays are related to the distance traveled
```{r delay vs distance}

```

## Hypothesis 2: delays are related to the flight company



# Conclusion

# To go deeper into Exploratory Data Analysis 
- [Modern Dive](http://moderndive.com/index.html)
- [ggplot2 cookbook](http://www.cookbook-r.com/Graphs/)


